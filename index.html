<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>00981A每日持股追蹤工具 v3.3 (雙圖表版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Sort Icons */
        .sort-icon::after { content: ' ↕'; opacity: 0.3; }
        .sort-asc::after { content: ' ↑'; opacity: 1; }
        .sort-desc::after { content: ' ↓'; opacity: 1; }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col items-center justify-start p-4 md:p-8">
        
        <!-- Tab Navigation -->
        <div class="w-full max-w-4xl mb-6 bg-white rounded-xl shadow-sm p-1 flex">
            <button onclick="switchTab('merger')" id="tab-merger" class="flex-1 py-3 px-6 rounded-lg font-bold text-sm transition-all duration-200 bg-blue-100 text-blue-700">1. 資料匯整</button>
            <button onclick="switchTab('viewer')" id="tab-viewer" class="flex-1 py-3 px-6 rounded-lg font-bold text-sm transition-all duration-200 text-gray-500 hover:bg-gray-50">2. 權重分佈 & 分析</button>
        </div>

        <!-- APP CONTAINER -->
        <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl p-8 space-y-8 min-h-[600px]">
            
            <!-- SECTION 1: MERGER TOOL -->
            <div id="section-merger" class="space-y-8">
                <div class="text-center border-b pb-6">
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        每日持股匯整工具
                    </h1>
                    <p class="text-gray-500 mt-2">支援批次處理多個日報表，將其合併為單一 Monitor 檔案</p>
                    <div class="mt-4">
                        <a href="https://www.ezmoney.com.tw/ETF/Fund/AssetExcelNPOI?fundCode=49YTW" target="_blank"
                           class="inline-flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold py-2 px-4 rounded-lg shadow-sm transition duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            下載最新成分股來源檔 (EZmoney)
                        </a>
                    </div>
                </div>

                <!-- Step 1 & 2: File Selection -->
                <div class="space-y-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">1. 選擇每日報表來源檔 (可多選)</label>
                        <div class="relative group">
                            <input type="file" id="sourceFile" accept=".xlsx, .xls" multiple
                                   class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer border rounded-lg p-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <p class="text-xs text-gray-400 pl-1">提示：按住 Ctrl 或 Shift 鍵可一次選擇多個檔案。</p>												
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 flex justify-between">
                            <span>2. 選擇現有彙整檔 (monitor.xlsx) <span class="text-gray-400 font-normal">[選填]</span></span>
                            <span class="text-xs text-amber-600 bg-amber-50 px-2 py-0.5 rounded">第一次匯整請留空</span>
                        </label>
                        <input type="file" id="monitorFile" accept=".xlsx, .xls" 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100 cursor-pointer border rounded-lg p-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <p class="text-xs text-gray-400 pl-1">系統將讀取此檔案，並將新資料加入或覆蓋舊有日期。</p>
                    </div>
                </div>

                <div class="pt-4 pb-8">
                    <button id="processBtn" onclick="processFiles()" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition duration-200 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        執行匯整並下載 Excel
                    </button>
                </div>
            </div>

            <!-- SECTION 2: VIEWER TOOL -->
            <div id="section-viewer" class="hidden space-y-8">
                <div class="text-center border-b pb-6">
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                        </svg>
                        持股權重分佈
                    </h1>
                    <p class="text-gray-500 mt-2">顯示最新日期的前 25 大持股權重分佈</p>
                </div>
                <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100">
                    <label class="block text-sm font-medium text-indigo-900 mb-2">請上傳 Monitor.xlsx 檔案</label>
                    <input type="file" id="viewerFile" accept=".xlsx, .xls" onchange="loadChartData()"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer border rounded-lg p-2 bg-white border-indigo-200">
                </div>
                
                <!-- Chart Container (Stacked Vertical) -->
                <div class="space-y-8">
                    <!-- Chart 1: Horizontal Bar -->
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <h3 class="font-bold text-gray-700 mb-4 pl-2 border-l-4 border-indigo-500">權重排行 (Top 25)</h3>
                        <div class="relative h-[600px] w-full">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>

                    <!-- Chart 2: Pie Chart -->
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <h3 class="font-bold text-gray-700 mb-4 pl-2 border-l-4 border-pink-500">權重比例分佈</h3>
                        <div class="relative h-[400px] w-full flex justify-center">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="space-y-2 pt-4">
                    <h3 class="font-bold text-gray-700 flex items-center gap-2">詳細數據 (前 25 檔)</h3>
                    <p class="text-xs text-gray-400">點擊欄位標題可進行排序</p>
                    <div class="border rounded-lg overflow-hidden bg-white shadow-sm">
                        <!-- Table Header -->
                        <div class="grid grid-cols-12 gap-2 p-3 bg-gray-100 font-bold text-xs text-gray-700 border-b items-center select-none">
                            <div class="col-span-1 cursor-pointer hover:text-indigo-600 sort-icon" id="header-rank" onclick="handleSort('rank')">排名</div>
                            <div class="col-span-2 cursor-pointer hover:text-indigo-600 sort-icon" id="header-name" onclick="handleSort('name')">股票名稱</div>
                            <div class="col-span-2 cursor-pointer hover:text-indigo-600 sort-icon text-center" id="header-trend" onclick="handleSort('trendVal')">趨勢訊號</div>
                            <div class="col-span-2 text-right cursor-pointer hover:text-indigo-600 sort-icon pr-2" id="header-diff" onclick="handleSort('diff')">日變動</div>
                            <!-- 新增：區間變動 (Total Diff) -->
                            <div class="col-span-2 text-right cursor-pointer hover:text-indigo-600 sort-icon pr-2" id="header-totalDiff" onclick="handleSort('totalDiff')">區間變動</div>
                            <!-- 調整：權重欄位改為 col-span-3 -->
                            <div class="col-span-3 text-right pr-4 cursor-pointer hover:text-indigo-600 sort-icon" id="header-weight" onclick="handleSort('weight')">最新權重 / 歷史</div>
                        </div>
                        <!-- Table Body -->
                        <div id="dataTableBody" class="custom-scrollbar overflow-y-auto max-h-[500px] divide-y divide-gray-100">
                            <div class="p-8 text-center text-gray-400 text-sm">請先上傳檔案以檢視數據</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div id="statusArea" class="hidden rounded-lg bg-gray-50 p-4 border border-gray-200 text-sm font-mono text-gray-700 space-y-1 max-h-40 overflow-y-auto"></div>
        </div>
        <div class="mt-8 text-center w-full text-xs text-gray-400">資料處理完全在瀏覽器端進行。無須上傳資料至任何伺服器。</div>
    </div>

    <script>
        // --- 共用變數 ---
        const TARGET_RANGE = { s: { c: 0, r: 20 }, e: { c: 3, r: 71 } }; // A21:D72
        const TARGET_SHEET_NAME = "基金投資組合";
        const OUTPUT_FILENAME = "monitor.xlsx";
        let globalProcessedWorkbook = null; 
        
        // Chart Instances
        let barChartInstance = null;
        let pieChartInstance = null;

        // --- Table Data & Sorting State ---
        let tableData = [];
        let sortState = { key: 'rank', dir: 'asc' }; // dir: 'asc' or 'desc'

        // --- Logger ---
        function log(message, type = 'info') {
            const statusArea = document.getElementById('statusArea');
            statusArea.classList.remove('hidden');
            const div = document.createElement('div');
            div.textContent = `> ${message}`;
            if (type === 'error') div.className = 'text-red-600 font-bold';
            if (type === 'success') div.className = 'text-green-600 font-bold';
            statusArea.appendChild(div);
            statusArea.scrollTop = statusArea.scrollHeight;
        }

        // --- Tab Switcher ---
        function switchTab(tab) {
            const mergerSec = document.getElementById('section-merger');
            const viewerSec = document.getElementById('section-viewer');
            const mergerBtn = document.getElementById('tab-merger');
            const viewerBtn = document.getElementById('tab-viewer');
            
            if (tab === 'merger') {
                mergerSec.classList.remove('hidden');
                viewerSec.classList.add('hidden');
                mergerBtn.className = "flex-1 py-3 px-6 rounded-lg font-bold text-sm bg-blue-100 text-blue-700";
                viewerBtn.className = "flex-1 py-3 px-6 rounded-lg font-bold text-sm text-gray-500 hover:bg-gray-50";
            } else {
                mergerSec.classList.add('hidden');
                viewerSec.classList.remove('hidden');
                viewerBtn.className = "flex-1 py-3 px-6 rounded-lg font-bold text-sm bg-indigo-100 text-indigo-700";
                mergerBtn.className = "flex-1 py-3 px-6 rounded-lg font-bold text-sm text-gray-500 hover:bg-gray-50";
            }
        }

        // --- File Reading Helpers ---
        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try { resolve(XLSX.read(new Uint8Array(e.target.result), { type: 'array' })); } 
                    catch (err) { reject(err); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function extractDateFromFilename(filename) {
            const match = filename.match(/(\d{8})/);
            if (match) return match[1];
            return new Date().toISOString().split('T')[0].replace(/-/g, '');
        }

        // --- CORE FUNCTION 1: Process Files (Merge) ---
        async function processFiles() {
            const sourceInput = document.getElementById('sourceFile');
            const monitorInput = document.getElementById('monitorFile');
            const btn = document.getElementById('processBtn');

            document.getElementById('statusArea').innerHTML = '';
            
            if (!sourceInput.files.length) { alert('請先選擇「每日報表來源檔」！'); return; }

            try {
                btn.disabled = true;
                btn.textContent = '處理中...';
                log('開始處理匯整...');

                let monitorWorkbook;
                let outputFilename = OUTPUT_FILENAME;

                if (monitorInput.files.length > 0) {
                    outputFilename = monitorInput.files[0].name;
                    monitorWorkbook = await readExcelFile(monitorInput.files[0]);
                } else {
                    monitorWorkbook = XLSX.utils.book_new();
                }

                const files = Array.from(sourceInput.files).sort((a, b) => a.name.localeCompare(b.name));
                let successCount = 0;

                for (let file of files) {
                    try {
                        const sheetNameDate = extractDateFromFilename(file.name);
                        const sourceWorkbook = await readExcelFile(file);
                        let targetSheet = sourceWorkbook.Sheets[TARGET_SHEET_NAME] || sourceWorkbook.Sheets[sourceWorkbook.SheetNames[0]];
                        
                        const extractedData = XLSX.utils.sheet_to_json(targetSheet, { header: 1, range: TARGET_RANGE });
                        if (extractedData.length === 0) continue;

                        if (monitorWorkbook.SheetNames.includes(sheetNameDate)) {
                            monitorWorkbook.SheetNames.splice(monitorWorkbook.SheetNames.indexOf(sheetNameDate), 1);
                            delete monitorWorkbook.Sheets[sheetNameDate];
                        }
                        XLSX.utils.book_append_sheet(monitorWorkbook, XLSX.utils.aoa_to_sheet(extractedData), sheetNameDate);
                        successCount++;
                        log(`已處理: ${sheetNameDate}`);
                    } catch (err) {
                        log(`跳過檔案 ${file.name}: ${err.message}`, 'error');
                    }
                }

                if (successCount > 0) {
                    XLSX.writeFile(monitorWorkbook, outputFilename);
                    globalProcessedWorkbook = monitorWorkbook; 
                    log(`匯整完成，已下載 ${outputFilename}`, 'success');
                } else {
                    alert('沒有任何有效數據被處理。');
                }

            } catch (error) {
                console.error(error);
                log(`錯誤: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    執行匯整並下載 Excel
                `;
            }
        }

        // --- CORE FUNCTION 2: Viewer Chart & Table ---
        async function loadChartData() {
            const fileInput = document.getElementById('viewerFile');
            if (!fileInput.files.length) return;
            document.getElementById('statusArea').innerHTML = '';
            
            try {
                const workbook = await readExcelFile(fileInput.files[0]);
                let sheets = workbook.SheetNames.sort();
                if (sheets.length === 0) return;

                const latestSheet = workbook.Sheets[sheets[sheets.length - 1]];
                const latestDataRaw = XLSX.utils.sheet_to_json(latestSheet, { header: 1 });
                
                let startIdx = (latestDataRaw.length > 0 && typeof latestDataRaw[0][1] === 'string' && latestDataRaw[0][1].includes('名稱')) ? 1 : 0;
                let targetStocks = [];
                // 調整：只取前 25 檔 (原本是 + 50)
                for (let i = startIdx; i < startIdx + 25; i++) {
                    if (latestDataRaw[i] && latestDataRaw[i][1]) targetStocks.push(latestDataRaw[i][1]);
                }

                const datasets = {};
                targetStocks.forEach(s => datasets[s] = []);

                sheets.forEach(sheetName => {
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                    const map = {};
                    rows.forEach(row => {
                        if (row.length > 3) {
                            let v = row[3];
                            if (typeof v === 'string') v = parseFloat(v.replace(/[%|,]/g, ''));
                            if (row[1] && !isNaN(v)) map[row[1]] = v;
                        }
                    });
                    targetStocks.forEach(s => datasets[s].push(map[s] !== undefined ? map[s] : null));
                });

                // Prepare Data for Charts (Using Latest Data)
                const latestWeights = targetStocks.map(s => {
                    const data = datasets[s];
                    return data[data.length - 1] || 0;
                });
                
                drawCharts(targetStocks, latestWeights);
                
                // --- Build Table Data ---
                tableData = targetStocks.map((s, i) => {
                    const vals = datasets[s];
                    const lastVal = vals[vals.length - 1];
                    const prevVal = vals.length >= 2 ? vals[vals.length - 2] : null;
                    const firstVal = vals.length > 0 ? vals[0] : null;
                    const trend = analyzeTrend(vals); 
                    
                    // 計算日差異
                    let diff = null;
                    if (lastVal !== null && prevVal !== null) {
                        diff = lastVal - prevVal;
                    }

                    // 計算總區間差異
                    const vLast = lastVal || 0;
                    const vFirst = firstVal || 0;
                    const totalDiff = vLast - vFirst;

                    return {
                        rank: i + 1,
                        name: s,
                        weight: lastVal,
                        history: vals,
                        trendText: trend.text,
                        trendClass: trend.class,
                        trendVal: trend.val,
                        diff: diff,
                        totalDiff: totalDiff
                    };
                });

                // Initial sort by rank
                handleSort('rank'); 

            } catch (err) {
                console.error(err);
                log(`解析錯誤: ${err.message}`, 'error');
            }
        }

        // --- Logic to detect Trends & New Entries ---
        function analyzeTrend(values) {
            const len = values.length;
            if (len < 2) return { text: '-', class: 'text-gray-300', val: 0 };

            const cur = values[len - 1];
            const prev = values[len - 2];
            const prev2 = len >= 3 ? values[len - 3] : null;

            const isCurValid = cur !== null && cur > 0;
            const isPrevValid = prev !== null && prev > 0;

            if (isCurValid && !isPrevValid) {
                return { text: '新入榜', class: 'bg-purple-100 text-purple-700 border-purple-200 border', val: 2 };
            }

            if (len >= 3 && isCurValid && isPrevValid && prev2 !== null && prev2 > 0) {
                if (cur > prev && prev > prev2) {
                    return { text: '連漲 3 天', class: 'bg-red-100 text-red-700 border-red-200 border', val: 1 };
                }
                if (cur < prev && prev < prev2) {
                    return { text: '連跌 3 天', class: 'bg-green-100 text-green-700 border-green-200 border', val: -1 };
                }
            }
            
            return { text: '-', class: 'text-gray-300', val: 0 };
        }

        function handleSort(key) {
            if (sortState.key === key) {
                sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.key = key;
                sortState.dir = (key === 'weight' || key === 'trendVal' || key === 'diff' || key === 'totalDiff') ? 'desc' : 'asc';
            }

            document.querySelectorAll('.sort-icon').forEach(el => {
                el.classList.remove('sort-asc', 'sort-desc');
                el.classList.add('opacity-70');
            });
            const activeHeader = document.querySelector(`#header-${key === 'trendVal' ? 'trend' : key}`);
            if (activeHeader) {
                activeHeader.classList.remove('opacity-70');
                activeHeader.classList.add(sortState.dir === 'asc' ? 'sort-asc' : 'sort-desc');
            }

            tableData.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];
                if (valA == null) valA = -Infinity;
                if (valB == null) valB = -Infinity;
                if (valA < valB) return sortState.dir === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.dir === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable();
        }

        function renderTable() {
            const container = document.getElementById('dataTableBody');
            container.innerHTML = '';
            
            tableData.forEach((rowObj) => {
                const s = rowObj.name;
                const vals = rowObj.history;
                const last = rowObj.weight;
                const diff = rowObj.diff;
                const totalDiff = rowObj.totalDiff;
                
                const formatDiff = (d) => {
                    if (d === null) return '<span class="text-gray-300">-</span>';
                    const sign = d > 0 ? '+' : '';
                    const colorClass = d > 0 ? 'text-red-600' : (d < 0 ? 'text-green-600' : 'text-gray-400');
                    if (Math.abs(d) < 0.0001) return '<span class="text-gray-400">0.00%</span>';
                    return `<span class="${colorClass}">${sign}${d.toFixed(2)}%</span>`;
                };

                const diffHtml = formatDiff(diff);
                const totalDiffHtml = formatDiff(totalDiff);

                const row = document.createElement('div');
                row.className = "grid grid-cols-12 gap-2 p-3 text-sm hover:bg-gray-50 items-center border-b border-gray-100 last:border-0";
                
                row.innerHTML = `
                    <div class="col-span-1 font-bold text-gray-500 pl-2">#${rowObj.rank}</div>
                    <div class="col-span-2 font-medium truncate" title="${s}">${s}</div>
                    <div class="col-span-2 text-center">
                        <span class="text-xs px-2 py-1 rounded-full font-bold ${rowObj.trendClass}">
                            ${rowObj.trendText}
                        </span>
                    </div>
                    <div class="col-span-2 text-right font-mono text-xs pr-2">
                        ${diffHtml}
                    </div>
                    <div class="col-span-2 text-right font-mono text-xs pr-2 border-l border-gray-100">
                        ${totalDiffHtml}
                    </div>
                    <div class="col-span-3 flex justify-end gap-2 items-center">
                        <span class="font-bold text-indigo-600 w-16 text-right">${last!=null?last.toFixed(2)+'%':'-'}</span>
                        <div class="hidden md:flex gap-0.5 w-24 justify-end">
                            ${vals.slice(-5).map(v=>`<span class="text-xs px-0.5 rounded ${v>0?'bg-green-100 text-green-700':'bg-gray-100 text-gray-400'}">.</span>`).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        // --- NEW: Draw 2 Charts (Bar & Pie) ---
        function drawCharts(stocks, weights) {
            const barCtx = document.getElementById('barChart').getContext('2d');
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            
            if (barChartInstance) barChartInstance.destroy();
            if (pieChartInstance) pieChartInstance.destroy();

            const colors = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef', '#f43f5e', '#881337', '#1e293b', '#64748b', '#78350f', '#111827', '#4b5563', '#9ca3af', '#fca5a5', '#fdba74', '#fcd34d', '#bef264', '#6ee7b7', '#67e8f9'];

            // 1. Horizontal Bar Chart
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: stocks,
                    datasets: [{
                        label: '權重 (%)',
                        data: weights,
                        backgroundColor: colors.slice(0, stocks.length),
                        borderColor: '#ffffff',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) { return context.raw.toFixed(2) + '%'; }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        y: { grid: { display: false } }
                    }
                }
            });

            // 2. Pie Chart
            pieChartInstance = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: stocks,
                    datasets: [{
                        data: weights,
                        backgroundColor: colors.slice(0, stocks.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) { 
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    label += context.raw.toFixed(2) + '%';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
